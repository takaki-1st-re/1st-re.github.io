<html>
  <head>
    <meta charset="utf-8">
    <title>GRATS_CardShopDedicatedSalesSite</title>
    <link href="https://takaki-1st-re.github.io/1st-re.github.io/style_login.css" rel="stylesheet" type="text/css">
  </head>
  <div class="text-center">
    <h2>注文内容確認</h2>
  </div>
  <div class="l_parent">
    <table id="orderInfoTable" border="1" style="border-collapse: collapse">
    </table>
  </div>
  <div class="l_parent">
    <table border="0">
      <tr>
        <td></td>
        <td>
          <input type="button" value="発注" onclick="procOrderByOwner()">
          <input type="button" value="キャンセル" onclick="history.back()">
        </td>
      </tr>
    </table>
  </div>
  <div class="text-center">
    <h3 id="error_info"></h3>
    <div id="color_list"></div>
  </div>
  <bottom>
    <img src="https://takaki-1st-re.github.io/1st-re.github.io/logo.png" alt="gratsLogoImage">
  </bottom>
  <script>

    var arrayOrderInfo = [];
    var arrayGoodsTagInfo = [];
    var loginShop
    var arrayGoodsOrdersInfo = [["", "個数", "単価(税込)", "計"]];
    var errorInfo = document.getElementById("error_info");

    function constractor()
    {
      let url = new URL(window.location.href);
      let urlParams = url.searchParams;

      var orderInfo = urlParams.get('order').slice(1).slice(0, -1);
      var arrOrder = orderInfo.split(']');

      for(var i = 0; i < arrOrder.length - 1; i++)
      {
        var element = arrOrder[i].slice(1);
        arrayOrderInfo[i] = element.split(',');
      }

      var csvFilePath = "https://takaki-1st-re.github.io/1st-re.github.io/GoodsTagInfo.csv";

      var request = new XMLHttpRequest();

      request.addEventListener('load', (event) => {
        var arrReq = event.target.responseText.split('\n');

        for(var i = 0; i < arrReq.length - 1; i++)
        {
          //","ごとに配列化
          arrayGoodsTagInfo[i] = arrReq[i].split(',');
        }

        var totalGoodsNum = 0;
        var totalPrice = 0;
        var previousOrdersGoodsIdNum = 0;
        var arrayBackGroundColorChangeCells = [];

        for(var i = 0; i < arrayOrderInfo.length; i++)
        {
          for(var j = 0; j < arrayGoodsTagInfo.length; j++)
          {
            if(arrayOrderInfo[i][0] == arrayGoodsTagInfo[j][0])
            {
              if (i == 0)
              {
                var interbalTitleElement = [arrayGoodsTagInfo[j][4], "", "", ""];
                arrayGoodsOrdersInfo.push(interbalTitleElement);
                arrayBackGroundColorChangeCells[arrayBackGroundColorChangeCells.length] = i + arrayBackGroundColorChangeCells.length + 1;
              }
              else if(arrayGoodsTagInfo[j][4] != arrayGoodsTagInfo[previousOrdersGoodsIdNum][4])
              {
                var interbalTitleElement = [arrayGoodsTagInfo[j][4], "", "", ""];
                arrayGoodsOrdersInfo.push(interbalTitleElement);
                arrayBackGroundColorChangeCells[arrayBackGroundColorChangeCells.length] = i + arrayBackGroundColorChangeCells.length + 1;
              }
              var totalGoodsPrice = Number(arrayOrderInfo[i][1]) * Number(arrayGoodsTagInfo[j][3]);
              totalPrice = totalPrice + totalGoodsPrice;
              totalGoodsNum = totalGoodsNum + Number(arrayOrderInfo[i][1]);
              var arrayElement = [arrayGoodsTagInfo[j][1], arrayOrderInfo[i][1], arrayGoodsTagInfo[j][3].trim() + " 円", String(totalGoodsPrice)　+ " 円"];
              arrayGoodsOrdersInfo.push(arrayElement);
              previousOrdersGoodsIdNum = j;
              break;
            }
          }
        }

        arrayElement = ["", "", "", ""];
        arrayGoodsOrdersInfo.push(arrayElement);
        var postage = 1000;
        arrayElement = ["送料", "", "", String(postage) + " 円"];
        arrayGoodsOrdersInfo.push(arrayElement);
        arrayElement = ["", "", "", ""];
        arrayGoodsOrdersInfo.push(arrayElement);
        totalPrice = totalPrice + postage;
        arrayElement = ["合計", totalGoodsNum, "", String(totalPrice)　+ " 円"];
        arrayGoodsOrdersInfo.push(arrayElement);

        var table = document.getElementById("orderInfoTable");

        for(i = 0; i < arrayGoodsOrdersInfo.length; i++){
          var row = document.createElement("tr");

          for(j = 0; j < arrayGoodsOrdersInfo[0].length; j++){
            var cell = document.createElement("td");

            cell.textContent = arrayGoodsOrdersInfo[i][j];

            if (arrayBackGroundColorChangeCells.includes(i))
            {
              cell.style.backgroundColor = "#87CEFA";
            }

            if (i == 0)
            {
              cell.align = "center";
            }
            else if(i == arrayGoodsOrdersInfo.length - 1 && j == 0 || i == arrayGoodsOrdersInfo.length - 3 && j == 0)
            {
                cell.align = "center";
            }
            else if (j == 1 || j == 2 || j == 3)
            {
              cell.align = "right";
            }

            row.appendChild(cell);
          }

          table.appendChild(row);
        }

      });

      request.open("get", csvFilePath, true);
      request.send();

    }

    function canselButtonEvent()
    {
      location.href = "https://takaki-1st-re.github.io/GRATS_CardShopDedicatedSalesSite_transaction.html";
    }

    function procOrderByOwner()
    {
      xhr = new XMLHttpRequest();

      var name = "timejudaedall.ooo@gmail.com";
      var email = "takaki@1st-re.com";
      var body = "ほんぶん";

      var postData = {"name":name, "email":email, "body":body};

      xhr.open('POST', 'SendAnEmail.php', true);
      xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
      xhr.send();
    }

    constractor();
  </script>
</html>
